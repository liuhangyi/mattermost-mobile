name: test
description: Common tests for mobile repo

inputs:
  github_token:
    description: The token to use to download the coverage result
    required: true
  run-id:
    description: The run id to use to download the coverage result
    required: true

runs:
  using: composite
  steps:
    - name: ci/prepare-node-deps
      uses: ./.github/actions/prepare-node-deps

    - name: ci/check-styles
      shell: bash
      run: |
        echo "::group::check-styles"
        npm run check
        echo "::endgroup::"

    - name: ci/download-current-coverage
      uses: actions/download-artifact@v4
      with:
        name: test-coverage-result-13765601687
        path: current-coverage/
        github-token: ${{ inputs.github_token }}
        run-id: 13765601687

    - name: ci/read-coverage
      shell: bash
      run: |
        echo "::group::read-coverage"
        ./scripts/read-coverage.sh ./current-coverage/coverage-summary.json
        echo "::endgroup::"

    - name: ci/run-tests
      shell: bash
      run: |
        echo "::group::run-tests"
        npm run test:coverage
        echo "::endgroup::"

    - name: ci/upload-coverage
      uses: actions/upload-artifact@v4
      with:
        name: test-coverage-result-${{ inputs.run-id }}
        path: coverage/coverage-summary.json
        overwrite: true

    - name: ci/check-i18n
      shell: bash
      run: |
        echo "::group::check-i18n"
        ./scripts/precommit/i18n.sh
        echo "::endgroup::"
